<!DOCTYPE html> 
<html> 
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="lyz"/>
	<link rel="stylesheet" href="css/style.css" class="css"/>
  <script src="http://cdn.bootcss.com/zepto/1.0rc1/zepto.min.js"></script>
</head> 
<body >
<audio id="music" loop="loop">
  <source src="music/vk.mp3">
  <source src="music/vk.ogg">
</audio>
<script type="text/javascript">
  function inRange(snow) {
    var x = snow.x,
        y = snow.y;
    var rect = {
      left: 200,
      right: 300,
      top: 200,
      bottom: 300
    }
    if (x > rect.left && x < rect.right &&
        y > rect.top && y < rect.bottom) {
      return true;
    } else {
      return false;
    }
  }
	// Cross-browser-compliant
    requestAnimationFrame = window.requestAnimationFrame ||
                            window.mozRequestAnimationFrame ||
                            window.webkitRequestAnimationFrame ||
                            window.msRequestAnimationFrame || 
                            window.oRequestAnimationFrame ||
                            function(callback) { setTimeout(callback, 1000 / 60); };

    /**
     * Snow Class
     * @param {int}   x      
     * @param {int}   y      
     * @param {int}   radius 
     * @param {Function} fn     Formular to calculate x pos and y pos
     */
    function Snow (x, y, radius, fn) {
    	this.x = x;
    	this.y = y;
    	this.r = radius;
    	this.fn = fn;
    }
    Snow.prototype.update = function () {
    	this.x = this.fn.x (this.x, this.y);
    	this.y = this.fn.y (this.y, this.y);

    	if (this.x > window.innerWidth ||
    		this.x < 0 ||
    		this.y > window.innerHeight ||
    		this.y < 0 
    	){
    		this.restart();
    	}

      var snow = this;
      if (inRange(snow)) {
        var _snow = {};
        _snow.x = parseInt(_snow.x);
        _snow.y = parseInt(_snow.y);
        var key = JSON.stringify(_snow);
        if (!(key in map)) {
//          _snow.y = parseInt(_snow)
//          _snow = $.extend({}, )
//          cover.push(_snow);
//          map[key] = 1;
//          console.log(_snow);
        }
        snow.restart();
      }
    }

  Snow.prototype.restart = function() {
    this.x = getRandom('x');
    this.y = 0;
  }

  Snow.prototype.draw = function (cxt) {
    var grd = cxt.createRadialGradient (this.x, this.y, 0, this.x, this.y, this.r);
    grd.addColorStop(0, "rgba(255, 255, 255, 0.9)");
    grd.addColorStop(.5, "rgba(255, 255, 255, 0.5)");
    grd.addColorStop(1, "rgba(255, 255, 255, 0)");
    cxt.fillStyle = grd;
    cxt.fillRect (this.x - this.r, this.y - this.r, this.r * 2, this.r * 2);
  }

  /**
   * Snowlist class
   * Container to hold snow objects
   */
  SnowList = function () {
    this.list = [];
  }
  SnowList.prototype.push = function (snow) {
    this.list.push (snow);
  }
  SnowList.prototype.update = function () {
    for (var i = 0, len = this.list.length; i < len; i++) {
      this.list[i].update();
    }
  }
  SnowList.prototype.draw = function (cxt) {
    for (var i = 0, len = this.list.length; i < len; i++) {
      this.list[i].draw (cxt);
    }
  }
  SnowList.prototype.get = function (i) {
    return this.list[i];
  }
  SnowList.prototype.size = function () {
    return this.list.length;
  }

  /**
   * Generate random x-pos, y-pos or fn functions
   * @param  {string} option x|y|fnx|fny
   * @return {int|Function}
   */
  function getRandom (option) {
    var ret, random;
    switch (option) {
      case 'x':
        ret = parseInt(Math.random () * window.innerWidth);
        break;
      case 'y':
        ret = parseInt(Math.random () * window.innerHeight);
        break;
      case 'r':
        ret = Math.random () * 5;
        break;
      case 'fnx':
        random = 27 + Math.random () * 100;
        ret = function (x, y) {
          return x +  0.1 * Math.sin (y / random) * 2.1;
        };
        break;
      case 'fny':
        random = 0.4 + Math.random () * 0.3;
        ret = function (x, y) {
          return y + random;
        };
        break;
    }
    return ret;
  }

  var cover = new SnowList();
  var map = {};
  // Start snow
  function startSnow () {
    // Create canvas
    var canvas = document.createElement ('canvas'), cxt;
    canvas.height = window.innerHeight;
    canvas.width = window.innerWidth;
    canvas.setAttribute ('style', 'pointer-events: none;');
    canvas.setAttribute ('id', 'canvas_snow');
    document.getElementsByTagName ('body')[0].appendChild (canvas);
    cxt = canvas.getContext ('2d');
    // Create snow objects
    var snowList = new SnowList();
    for(var i = 0; i < 277; i++){
      var snow, randomX, randomY, randomR, randomFnx, randomFny;
      randomX = getRandom ('x');
      randomY = getRandom ('y');
      randomR = getRandom ('r');
      randomFnx = getRandom('fnx');
      randomFny = getRandom('fny');
      snow = new Snow (randomX, randomY, randomR, {
        x: randomFnx,
        y: randomFny
      });
      snow.draw (cxt);
      snowList.push (snow);
    }
    // Update snow position data, and redraw them in each frame
    requestAnimationFrame (function(){
      cxt.clearRect (0, 0, canvas.width, canvas.height);
      snowList.update ();
      snowList.draw (cxt);
      cover.draw(cxt);
      requestAnimationFrame (arguments.callee);
    })
  }

  // Handle window resize
  window.onresize = function () {
    var canvasSnow = document.getElementById('canvas_snow');
    canvasSnow.width = window.innerWidth;
    canvasSnow.height = window.innerHeight;
  }

  // Let it snow O(∩_∩)0
  startSnow ();
</script>
<script type="text/javascript">
  function fakeClick(fn) {
    var $a = $('<a href="#" id="fakeClick"></a>');
    $a.bind("click", function(e) {
      e.preventDefault();
      fn();
    });

    $("body").append($a);

    var evt,
        el = $("#fakeClick").get(0);

    if (document.createEvent) {
      evt = document.createEvent("MouseEvents");
      if (evt.initMouseEvent) {
        evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        el.dispatchEvent(evt);
      }
    }

    $(el).remove();
  }

  $(function() {
    var video = $("#music").get(0);

    fakeClick(function() {
      video.play();
    });
  });

</script>
</body> 
</html>